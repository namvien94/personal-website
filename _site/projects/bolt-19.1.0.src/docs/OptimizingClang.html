<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>optimizingclang â€“ Nam Vien</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Nam Vien</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../About.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../coursework.html"> 
<span class="menu-text">Coursework</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#optimizing-clang-a-practical-example-of-applying-bolt" id="toc-optimizing-clang-a-practical-example-of-applying-bolt" class="nav-link active" data-scroll-target="#optimizing-clang-a-practical-example-of-applying-bolt">Optimizing Clang : A Practical Example of Applying BOLT</a>
  <ul class="collapse">
  <li><a href="#preface" id="toc-preface" class="nav-link" data-scroll-target="#preface">Preface</a></li>
  <li><a href="#building-clang" id="toc-building-clang" class="nav-link" data-scroll-target="#building-clang">Building Clang</a></li>
  <li><a href="#optimizing-clang-with-bolt" id="toc-optimizing-clang-with-bolt" class="nav-link" data-scroll-target="#optimizing-clang-with-bolt">Optimizing Clang with BOLT</a></li>
  <li><a href="#measuring-compile-time-improvement" id="toc-measuring-compile-time-improvement" class="nav-link" data-scroll-target="#measuring-compile-time-improvement">Measuring Compile-time Improvement</a></li>
  <li><a href="#source-of-the-wins" id="toc-source-of-the-wins" class="nav-link" data-scroll-target="#source-of-the-wins">Source of the Wins</a></li>
  <li><a href="#using-clang-for-other-applications" id="toc-using-clang-for-other-applications" class="nav-link" data-scroll-target="#using-clang-for-other-applications">Using Clang for Other Applications</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul></li>
  <li><a href="#appendix" id="toc-appendix" class="nav-link" data-scroll-target="#appendix">Appendix</a>
  <ul class="collapse">
  <li><a href="#bootstrapping-clang-7-with-pgo-and-lto" id="toc-bootstrapping-clang-7-with-pgo-and-lto" class="nav-link" data-scroll-target="#bootstrapping-clang-7-with-pgo-and-lto">Bootstrapping Clang-7 with PGO and LTO</a>
  <ul class="collapse">
  <li><a href="#getting-clang-7-sources" id="toc-getting-clang-7-sources" class="nav-link" data-scroll-target="#getting-clang-7-sources">Getting Clang-7 Sources</a></li>
  <li><a href="#building-stage-1-compiler" id="toc-building-stage-1-compiler" class="nav-link" data-scroll-target="#building-stage-1-compiler">Building Stage 1 Compiler</a></li>
  <li><a href="#building-stage-2-compiler-with-instrumentation" id="toc-building-stage-2-compiler-with-instrumentation" class="nav-link" data-scroll-target="#building-stage-2-compiler-with-instrumentation">Building Stage 2 Compiler With Instrumentation</a></li>
  <li><a href="#generating-profile-for-pgo" id="toc-generating-profile-for-pgo" class="nav-link" data-scroll-target="#generating-profile-for-pgo">Generating Profile for PGO</a></li>
  <li><a href="#building-clang-with-pgo-and-lto" id="toc-building-clang-with-pgo-and-lto" class="nav-link" data-scroll-target="#building-clang-with-pgo-and-lto">Building Clang with PGO and LTO</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">




<section id="optimizing-clang-a-practical-example-of-applying-bolt" class="level1">
<h1>Optimizing Clang : A Practical Example of Applying BOLT</h1>
<section id="preface" class="level2">
<h2 class="anchored" data-anchor-id="preface">Preface</h2>
<p><em>BOLT</em> (Binary Optimization and Layout Tool) is designed to improve the application performance by laying out code in a manner that helps CPU better utilize its caching and branch predicting resources.</p>
<p>The most obvious candidates for BOLT optimizations are programs that suffer from many instruction cache and iTLB misses, such as large applications measuring over hundreds of megabytes in size. However, medium-sized programs can benefit too. Clang, one of the most popular open-source C/C++ compilers, is a good example of the latter. Its code size could easily be in the order of tens of megabytes. As we will see, the Clang binary suffers from many instruction cache misses and can be significantly improved with BOLT, even on top of profile-guided and link-time optimizations.</p>
<p>In this tutorial we will first build Clang with PGO and LTO, and then will show steps on how to apply BOLT optimizations to make Clang up to 15% faster. We will also analyze where the compile-time performance gains are coming from, and verify that the speed-ups are sustainable while building other applications.</p>
</section>
<section id="building-clang" class="level2">
<h2 class="anchored" data-anchor-id="building-clang">Building Clang</h2>
<p>The process of getting Clang sources and performing the build is very similar to the one described at http://clang.llvm.org/get_started.html. For completeness, we provide the detailed steps on how to obtain and build Clang in <a href="#bootstrapping-clang-7-with-pgo-and-lto">Bootstrapping Clang-7 with PGO and LTO</a> section.</p>
<p>The only difference from the standard Clang build is that we require the <code>-Wl,-q</code> flag to be present during the final link. This option saves relocation metadata in the executable file, but does not affect the generated code in any way.</p>
</section>
<section id="optimizing-clang-with-bolt" class="level2">
<h2 class="anchored" data-anchor-id="optimizing-clang-with-bolt">Optimizing Clang with BOLT</h2>
<p>We will use the setup described in <a href="#bootstrapping-clang-7-with-pgo-and-lto">Bootstrapping Clang-7 with PGO and LTO</a>. Adjust the steps accordingly if you skipped that section. We will also assume that <code>llvm-bolt</code> is present in your <code>$PATH</code>.</p>
<p>Before we can run BOLT optimizations, we need to collect the profile for Clang, and we will use Clang/LLVM sources for that. Collecting accurate profile requires running <code>perf</code> on a hardware that implements taken branch sampling (<code>-b/-j</code> flag). For that reason, it may not be possible to collect the accurate profile in a virtualized environment, e.g.&nbsp;in the cloud. We do support regular sampling profiles, but the performance improvements are expected to be more modest.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mkdir <span class="va">${TOPLEV}</span>/stage3</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd <span class="va">${TOPLEV}</span>/stage3</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> CPATH=<span class="va">${TOPLEV}</span>/stage2-prof-use-lto/install/bin/</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cmake <span class="at">-G</span> Ninja <span class="va">${TOPLEV}</span>/llvm <span class="at">-DLLVM_TARGETS_TO_BUILD</span><span class="op">=</span>X86 <span class="at">-DCMAKE_BUILD_TYPE</span><span class="op">=</span>Release <span class="dt">\</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">-DCMAKE_C_COMPILER</span><span class="op">=</span><span class="va">$CPATH</span>/clang <span class="at">-DCMAKE_CXX_COMPILER</span><span class="op">=</span><span class="va">$CPATH</span>/clang++ <span class="dt">\</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">-DLLVM_ENABLE_PROJECTS</span><span class="op">=</span><span class="st">"clang"</span> <span class="dt">\</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">-DLLVM_USE_LINKER</span><span class="op">=</span>lld <span class="at">-DCMAKE_INSTALL_PREFIX</span><span class="op">=</span><span class="va">${TOPLEV}</span>/stage3/install</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> perf record <span class="at">-e</span> cycles:u <span class="at">-j</span> any,u <span class="at">--</span> ninja clang</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Once the last command is finished, it will create a <code>perf.data</code> file larger than 10GiB. We will first convert this profile into a more compact aggregated form suitable to be consumed by BOLT:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>  <span class="ex">$</span> perf2bolt <span class="va">$CPATH</span>/clang-7 <span class="at">-p</span> perf.data <span class="at">-o</span> clang-7.fdata <span class="at">-w</span> clang-7.yaml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Notice that we are passing <code>clang-7</code> to <code>perf2bolt</code> which is the real binary that <code>clang</code> and <code>clang++</code> are symlinking to. The next step will optimize Clang using the generated profile:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> llvm-bolt <span class="va">$CPATH</span>/clang-7 <span class="at">-o</span> <span class="va">$CPATH</span>/clang-7.bolt <span class="at">-b</span> clang-7.yaml <span class="dt">\</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">-reorder-blocks</span><span class="op">=</span>ext-tsp <span class="at">-reorder-functions</span><span class="op">=</span>hfsort+ <span class="at">-split-functions</span> <span class="dt">\</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">-split-all-cold</span> <span class="at">-dyno-stats</span> <span class="at">-icf</span><span class="op">=</span>1 <span class="at">-use-gnu-stack</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The output will look similar to the one below:</p>
<pre class="t"><code>...
BOLT-INFO: enabling relocation mode
BOLT-INFO: 11415 functions out of 104526 simple functions (10.9%) have non-empty execution profile.
...
BOLT-INFO: ICF folded 29144 out of 105177 functions in 8 passes. 82 functions had jump tables.
BOLT-INFO: Removing all identical functions will save 5466.69 KB of code space. Folded functions were called 2131985 times based on profile.
BOLT-INFO: basic block reordering modified layout of 7848 (10.32%) functions
...
           660155947 : executed forward branches (-2.3%)
            48252553 : taken forward branches (-57.2%)
           129897961 : executed backward branches (+13.8%)
            52389551 : taken backward branches (-19.5%)
            35650038 : executed unconditional branches (-33.2%)
           128338874 : all function calls (=)
            19010563 : indirect calls (=)
             9918250 : PLT calls (=)
          6113398840 : executed instructions (-0.6%)
          1519537463 : executed load instructions (=)
           943321306 : executed store instructions (=)
            20467109 : taken jump table branches (=)
           825703946 : total branches (-2.1%)
           136292142 : taken branches (-41.1%)
           689411804 : non-taken conditional branches (+12.6%)
           100642104 : taken conditional branches (-43.4%)
           790053908 : all conditional branches (=)
...</code></pre>
<p>The statistics in the output is based on the LBR profile collected with <code>perf</code>, and since we were using the <code>cycles</code> counter, its accuracy is affected. However, the relative improvement in <code>taken conditional  branches</code> is a good indication that BOLT was able to straighten out the code even after PGO.</p>
</section>
<section id="measuring-compile-time-improvement" class="level2">
<h2 class="anchored" data-anchor-id="measuring-compile-time-improvement">Measuring Compile-time Improvement</h2>
<p><code>clang-7.bolt</code> can be used as a replacement for <em>PGO+LTO</em> Clang:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mv <span class="va">$CPATH</span>/clang-7 <span class="va">$CPATH</span>/clang-7.org</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ln <span class="at">-fs</span> <span class="va">$CPATH</span>/clang-7.bolt <span class="va">$CPATH</span>/clang-7</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Doing a new build of Clang using the new binary shows a significant overall build time reduction on a 48-core Haswell system:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ln <span class="at">-fs</span> <span class="va">$CPATH</span>/clang-7.org <span class="va">$CPATH</span>/clang-7</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ninja clean <span class="kw">&amp;&amp;</span> <span class="ex">/bin/time</span> <span class="at">-f</span> %e ninja clang <span class="at">-j48</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="ex">202.72</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ln <span class="at">-fs</span> <span class="va">$CPATH</span>/clang-7.bolt <span class="va">$CPATH</span>/clang-7</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ninja clean <span class="kw">&amp;&amp;</span> <span class="ex">/bin/time</span> <span class="at">-f</span> %e ninja clang <span class="at">-j48</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="ex">180.11</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Thatâ€™s 22.61 seconds (or 12%) faster compared to the <em>PGO+LTO</em> build. Notice that we are measuring an improvement of the total build time, which includes the time spent in the linker. Compilation time improvements for individual files differ, and speedups over 15% are not uncommon. If we run BOLT on a Clang binary compiled without <em>PGO+LTO</em> (in which case the build is finished in 253.32 seconds), the gains we see are over 50 seconds (25%), but, as expected, the result is still slower than <em>PGO+LTO+BOLT</em> build.</p>
</section>
<section id="source-of-the-wins" class="level2">
<h2 class="anchored" data-anchor-id="source-of-the-wins">Source of the Wins</h2>
<p>We mentioned that Clang suffers from considerable instruction cache misses. This can be measured with <code>perf</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ln <span class="at">-fs</span> <span class="va">$CPATH</span>/clang-7.org <span class="va">$CPATH</span>/clang-7</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ninja clean <span class="kw">&amp;&amp;</span> <span class="ex">perf</span> stat <span class="at">-e</span> instructions,L1-icache-misses <span class="at">--</span> ninja clang <span class="at">-j48</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">...</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>   <span class="ex">16,366,101,626,647</span>      instructions</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>      <span class="ex">359,996,216,537</span>      L1-icache-misses</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Thatâ€™s about 22 instruction cache misses per thousand instructions. As a rule of thumb, if the application has over 10 misses per thousand instructions, it is a good indication that it will be improved by BOLT. Now letâ€™s see how many misses are in the BOLTed binary:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ln <span class="at">-fs</span> <span class="va">$CPATH</span>/clang-7.bolt <span class="va">$CPATH</span>/clang-7</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ninja clean <span class="kw">&amp;&amp;</span> <span class="ex">perf</span> stat <span class="at">-e</span> instructions,L1-icache-misses <span class="at">--</span> ninja clang <span class="at">-j48</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">...</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">16,319,818,488,769</span>      instructions</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>     <span class="ex">244,888,677,972</span>      L1-icache-misses</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The number of misses per thousand instructions went down from 22 to 15, significantly reducing the number of stalls in the CPU front-end. Notice how the number of executed instructions stayed roughly the same. Thatâ€™s because we didnâ€™t run any optimizations beyond the ones affecting the code layout. Other than instruction cache misses, BOLT also improves branch mispredictions, iTLB misses, and misses in L2 and L3.</p>
</section>
<section id="using-clang-for-other-applications" class="level2">
<h2 class="anchored" data-anchor-id="using-clang-for-other-applications">Using Clang for Other Applications</h2>
<p>We have collected profile for Clang using its own source code. Would it be enough to speed up the compilation of other projects? We picked <code>mysqld</code>, an open-source database, to do the test.</p>
<p>On our 48-core Haswell system using the <em>PGO+LTO</em> Clang, the build finished in 136.06 seconds, while using the <em>PGO+LTO+BOLT</em> Clang, 126.10 seconds. Thatâ€™s a noticeable improvement, but not as significant as the one we saw on Clang itself. This is partially because the number of instruction cache misses is slightly lower on this scenario : 19 vs 22. Another reason is that Clang is run with a different set of options while building <code>mysqld</code> compared to the training run.</p>
<p>Different options exercise different code paths, and if we trained without a specific option, we may have misplaced parts of the code responsible for handling it. To test this theory, we have collected another <code>perf</code> profile while building <code>mysqld</code>, and merged it with an existing profile using the <code>merge-fdata</code> utility that comes with BOLT. Optimized with that profile, the <em>PGO+LTO+BOLT</em> Clang was able to perform the <code>mysqld</code> build in 124.74 seconds, i.e.&nbsp;11 seconds or 9% faster compared to <em>PGO+LGO</em> Clang. The merged profile didnâ€™t make the original Clang compilation slower either, while the number of profiled functions in Clang increased from 11,415 to 14,025.</p>
<p>Ideally, the profile run has to be done with a superset of all commonly used options. However, the main improvement is expected with just the basic set.</p>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>In this tutorial we demonstrated how to use BOLT to improve the performance of the Clang compiler. Similarly, BOLT could be used to improve the performance of GCC, or any other application suffering from a high number of instruction cache misses.</p>
<hr>
</section>
</section>
<section id="appendix" class="level1">
<h1>Appendix</h1>
<section id="bootstrapping-clang-7-with-pgo-and-lto" class="level2">
<h2 class="anchored" data-anchor-id="bootstrapping-clang-7-with-pgo-and-lto">Bootstrapping Clang-7 with PGO and LTO</h2>
<p>Below we describe detailed steps to build Clang, and make it ready for BOLT optimizations. If you already have the build setup, you can skip this section, except for the last step that adds <code>-Wl,-q</code> linker flag to the final build.</p>
<section id="getting-clang-7-sources" class="level3">
<h3 class="anchored" data-anchor-id="getting-clang-7-sources">Getting Clang-7 Sources</h3>
<p>Set <code>$TOPLEV</code> to the directory of your preference where you would like to do builds. E.g. <code>TOPLEV=~/clang-7/</code>. Follow with commands to clone the <code>release_70</code> branch of LLVM monorepo:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mkdir <span class="va">${TOPLEV}</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd <span class="va">${TOPLEV}</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git clone <span class="at">--branch</span><span class="op">=</span>release/7.x https://github.com/llvm/llvm-project.git</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="building-stage-1-compiler" class="level3">
<h3 class="anchored" data-anchor-id="building-stage-1-compiler">Building Stage 1 Compiler</h3>
<p>Stage 1 will be the first build we are going to do, and we will be using the default system compiler to build Clang. If your system lacks a compiler, use your distribution package manager to install one that supports C++11. In this example we are going to use GCC. In addition to the compiler, you will need the <code>cmake</code> and <code>ninja</code> packages. Note that we disable the build of certain compiler-rt components that are known to cause build issues at release/7.x.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mkdir <span class="va">${TOPLEV}</span>/stage1</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd <span class="va">${TOPLEV}</span>/stage1</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cmake <span class="at">-G</span> Ninja <span class="va">${TOPLEV}</span>/llvm-project/llvm <span class="at">-DLLVM_TARGETS_TO_BUILD</span><span class="op">=</span>X86 <span class="dt">\</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">-DCMAKE_BUILD_TYPE</span><span class="op">=</span>Release <span class="dt">\</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">-DCMAKE_C_COMPILER</span><span class="op">=</span>gcc <span class="at">-DCMAKE_CXX_COMPILER</span><span class="op">=</span>g++ <span class="at">-DCMAKE_ASM_COMPILER</span><span class="op">=</span>gcc <span class="dt">\</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">-DLLVM_ENABLE_PROJECTS</span><span class="op">=</span><span class="st">"clang;lld"</span> <span class="dt">\</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">-DLLVM_ENABLE_RUNTIMES</span><span class="op">=</span><span class="st">"compiler-rt"</span> <span class="dt">\</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">-DCOMPILER_RT_BUILD_SANITIZERS</span><span class="op">=</span>OFF <span class="at">-DCOMPILER_RT_BUILD_XRAY</span><span class="op">=</span>OFF <span class="dt">\</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">-DCOMPILER_RT_BUILD_LIBFUZZER</span><span class="op">=</span>OFF <span class="dt">\</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">-DCMAKE_INSTALL_PREFIX</span><span class="op">=</span><span class="va">${TOPLEV}</span>/stage1/install</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ninja install</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="building-stage-2-compiler-with-instrumentation" class="level3">
<h3 class="anchored" data-anchor-id="building-stage-2-compiler-with-instrumentation">Building Stage 2 Compiler With Instrumentation</h3>
<p>Using the freshly-baked stage 1 Clang compiler, we are going to build Clang with profile generation capabilities:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mkdir <span class="va">${TOPLEV}</span>/stage2-prof-gen</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd <span class="va">${TOPLEV}</span>/stage2-prof-gen</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> CPATH=<span class="va">${TOPLEV}</span>/stage1/install/bin/</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cmake <span class="at">-G</span> Ninja <span class="va">${TOPLEV}</span>/llvm-project/llvm <span class="at">-DLLVM_TARGETS_TO_BUILD</span><span class="op">=</span>X86 <span class="dt">\</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">-DCMAKE_BUILD_TYPE</span><span class="op">=</span>Release <span class="dt">\</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">-DCMAKE_C_COMPILER</span><span class="op">=</span><span class="va">$CPATH</span>/clang <span class="at">-DCMAKE_CXX_COMPILER</span><span class="op">=</span><span class="va">$CPATH</span>/clang++ <span class="dt">\</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">-DLLVM_ENABLE_PROJECTS</span><span class="op">=</span><span class="st">"clang;lld"</span> <span class="dt">\</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">-DLLVM_USE_LINKER</span><span class="op">=</span>lld <span class="at">-DLLVM_BUILD_INSTRUMENTED</span><span class="op">=</span>ON <span class="dt">\</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">-DCMAKE_INSTALL_PREFIX</span><span class="op">=</span><span class="va">${TOPLEV}</span>/stage2-prof-gen/install</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ninja install</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="generating-profile-for-pgo" class="level3">
<h3 class="anchored" data-anchor-id="generating-profile-for-pgo">Generating Profile for PGO</h3>
<p>While there are many ways to obtain the profile data, we are going to use the source code already at our disposal, i.e.&nbsp;we are going to collect the profile while building Clang itself:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mkdir <span class="va">${TOPLEV}</span>/stage3-train</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd <span class="va">${TOPLEV}</span>/stage3-train</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> CPATH=<span class="va">${TOPLEV}</span>/stage2-prof-gen/install/bin</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cmake <span class="at">-G</span> Ninja <span class="va">${TOPLEV}</span>/llvm-project/llvm <span class="at">-DLLVM_TARGETS_TO_BUILD</span><span class="op">=</span>X86 <span class="dt">\</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">-DCMAKE_BUILD_TYPE</span><span class="op">=</span>Release <span class="dt">\</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">-DCMAKE_C_COMPILER</span><span class="op">=</span><span class="va">$CPATH</span>/clang <span class="at">-DCMAKE_CXX_COMPILER</span><span class="op">=</span><span class="va">$CPATH</span>/clang++ <span class="dt">\</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">-DLLVM_ENABLE_PROJECTS</span><span class="op">=</span><span class="st">"clang"</span> <span class="dt">\</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">-DLLVM_USE_LINKER</span><span class="op">=</span>lld <span class="at">-DCMAKE_INSTALL_PREFIX</span><span class="op">=</span><span class="va">${TOPLEV}</span>/stage3-train/install</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ninja clang</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Once the build is completed, the profile files will be saved under <code>${TOPLEV}/stage2-prof-gen/profiles</code>. We will merge them before they can be passed back into Clang:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd <span class="va">${TOPLEV}</span>/stage2-prof-gen/profiles</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> <span class="va">${TOPLEV}</span>/stage1/install/bin/llvm-profdata merge <span class="at">-output</span><span class="op">=</span>clang.profdata <span class="pp">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="building-clang-with-pgo-and-lto" class="level3">
<h3 class="anchored" data-anchor-id="building-clang-with-pgo-and-lto">Building Clang with PGO and LTO</h3>
<p>Now the profile can be used to guide optimizations to produce better code for our scenario, i.e.&nbsp;building Clang. We will also enable link-time optimizations to allow cross-module inlining and other optimizations. Finally, we are going to add one extra step that is useful for BOLT: a linker flag instructing it to preserve relocations in the output binary. Note that this flag does not affect the generated code or data used at runtime, it only writes metadata to the file on disk:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mkdir <span class="va">${TOPLEV}</span>/stage2-prof-use-lto</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd <span class="va">${TOPLEV}</span>/stage2-prof-use-lto</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> CPATH=<span class="va">${TOPLEV}</span>/stage1/install/bin/</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> export LDFLAGS=<span class="st">"-Wl,-q"</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cmake <span class="at">-G</span> Ninja <span class="va">${TOPLEV}</span>/llvm-project/llvm <span class="at">-DLLVM_TARGETS_TO_BUILD</span><span class="op">=</span>X86 <span class="dt">\</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">-DCMAKE_BUILD_TYPE</span><span class="op">=</span>Release <span class="dt">\</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">-DCMAKE_C_COMPILER</span><span class="op">=</span><span class="va">$CPATH</span>/clang <span class="at">-DCMAKE_CXX_COMPILER</span><span class="op">=</span><span class="va">$CPATH</span>/clang++ <span class="dt">\</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">-DLLVM_ENABLE_PROJECTS</span><span class="op">=</span><span class="st">"clang;lld"</span> <span class="dt">\</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">-DLLVM_ENABLE_LTO</span><span class="op">=</span>Full <span class="dt">\</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">-DLLVM_PROFDATA_FILE</span><span class="op">=</span><span class="va">${TOPLEV}</span>/stage2-prof-gen/profiles/clang.profdata <span class="dt">\</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">-DLLVM_USE_LINKER</span><span class="op">=</span>lld <span class="dt">\</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">-DCMAKE_INSTALL_PREFIX</span><span class="op">=</span><span class="va">${TOPLEV}</span>/stage2-prof-use-lto/install</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ninja install</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now we have a Clang compiler that can build itself much faster. As we will see, it builds other applications faster as well, and, with BOLT, the compile time can be improved even further.</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Â© 2024, Nam Vien</p>
</div>
  </div>
</footer>




</body></html>